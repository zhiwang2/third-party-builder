name: jbig2enc Windows (x86_64)

on:
  workflow_dispatch:

jobs:
  build-win:
    runs-on: windows-latest

    steps:
      - name: Setup MSYS2 (MINGW64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            git
            m4
            autoconf
            automake
            libtool
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-zlib
            mingw-w64-x86_64-leptonica
            mingw-w64-x86_64-libpng
            mingw-w64-x86_64-libjpeg-turbo
            mingw-w64-x86_64-libtiff

      - name: Build jbig2enc 0.30 (with Leptonica)
        shell: msys2 {0}
        run: |
          set -ex

          # 1) 路径与 pkg-config 包装器（强制用 MINGW 的 pkgconf）
          export PATH="/mingw64/bin:$PATH"
          WRAPBIN="$(mktemp -d)"
          printf '#!/bin/sh\nexec /mingw64/bin/pkgconf "$@"\n' > "$WRAPBIN/pkg-config"
          chmod +x "$WRAPBIN/pkg-config"
          export PATH="$WRAPBIN:$PATH"
          export PKG_CONFIG_PATH="/mingw64/lib/pkgconfig:/mingw64/share/pkgconfig"

          # 2) 诊断：确保能找到 zlib 和 lept
          which pkg-config
          pkg-config --version
          pkg-config --modversion zlib
          pkg-config --modversion lept

          # 3) 明确好编译/链接参数（双保险）
          ZCFLAGS="$(pkg-config --cflags zlib)"
          ZLIBS="$(pkg-config --libs zlib)"
          LCFLAGS="$(pkg-config --cflags lept || true)"
          LLEPTS="$(pkg-config --libs lept || true)"

          # 4) 快速自测 -lz
          printf '#include <zlib.h>\nint main(){return zlibVersion()[0];}\n' > ztest.c
          gcc $ZCFLAGS ztest.c $ZLIBS -o ztest.exe
          ./ztest.exe || true

          # 5) 克隆并生成 configure
          git clone --depth 1 --branch 0.30 https://github.com/agl/jbig2enc.git
          cd jbig2enc
          ./autogen.sh

          # 6) 精准“钉死” zlib fatal：只把两种致命报错改为警告，不动其它逻辑
          # 6.1 as_fn_error 形式
          sed -i -E 's/as_fn_error [^"]*"Error! zlib not detected\."[^$]*/{ echo "warning: zlib check skipped (CI)"; }/g' configure
          # 6.2 简单 echo + exit 1 形式
          sed -i -E 's/(echo "Error! zlib not detected\." *; *)exit 1/\1: # skip exit/g' configure

          # 7) 配置：显式带上 zlib/lept 的 CFLAGS/LIBS
          ./configure \
            --prefix="$PWD/../install_jb2" \
            ZLIB_CFLAGS="$ZCFLAGS" \
            ZLIB_LIBS="$ZLIBS" \
            LEPTONICA_CFLAGS="$LCFLAGS" \
            LEPTONICA_LIBS="$LLEPTS"

          make -j"$(nproc || echo 2)"
          make install

      - name: Collect artifacts
        shell: msys2 {0}
        run: |
          set -ex
          mkdir -p out/bin out/include out/lib out/deps/leptonica out/logs

          # 程序
          cp -v install_jb2/bin/jbig2enc.exe out/bin/

          # 运行时 DLL（存在就带上）
          for f in \
            /mingw64/bin/zlib1.dll \
            /mingw64/bin/lept*.dll \
            /mingw64/bin/libpng*.dll \
            /mingw64/bin/libjpeg*.dll \
            /mingw64/bin/libtiff*.dll \
            /mingw64/bin/libgcc_s_seh-1.dll \
            /mingw64/bin/libstdc++-6.dll \
            /mingw64/bin/libwinpthread-1.dll ; do
            [ -f "$f" ] && cp -v "$f" out/bin/ || true
          done

          # Leptonica 头/库/pc（方便后续离线链接）
          cp -rv /mingw64/include/leptonica out/deps/leptonica/include || true
          mkdir -p out/deps/leptonica/lib/pkgconfig
          cp -rv /mingw64/lib/libLept*.a out/deps/leptonica/lib || true
          cp -v  /mingw64/lib/pkgconfig/lept*.pc out/deps/leptonica/lib/pkgconfig || true

          # 产物与日志
          [ -d install_jb2/include ] && cp -rv install_jb2/include/* out/include/ || true
          [ -d install_jb2/lib ]     && cp -rv install_jb2/lib/*     out/lib/     || true
          [ -f jbig2enc/config.log ] && cp -v jbig2enc/config.log out/logs/config.log || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: jbig2enc-0.30-windows-x86_64
          path: out/**
