name: Third-Party (jbig2enc + verapdf)

on:
  workflow_dispatch:  # 仅手动

jobs:
  # ======================== jbig2enc + Leptonica (Linux) ========================
  jbig2enc_linux:
    name: jbig2enc 0.30 (+leptonica) — Linux
    runs-on: ubuntu-22.04
    steps:
      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential autoconf automake libtool pkg-config git \
            zlib1g-dev libpng-dev libjpeg-turbo8-dev libtiff-dev
      - name: Build Leptonica (from source)
        run: |
          set -eux
          git clone --depth 1 https://github.com/DanBloomberg/leptonica.git
          cd leptonica
          ./autogen.sh
          ./configure --prefix="$PWD/../install_lept"
          make -j
          make install
      - name: Build jbig2enc 0.30
        run: |
          set -eux
          git clone --depth 1 --branch 0.30 https://github.com/agl/jbig2enc.git
          cd jbig2enc
          ./autogen.sh
          PKG_CONFIG_PATH="$PWD/../install_lept/lib/pkgconfig" ./configure --prefix="$PWD/../install_jb2"
          make -j
          make install
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: jbig2enc-0.30-Linux
          path: install_jb2/**

  # ======================== jbig2enc + Leptonica (macOS) =======================
  jbig2enc_macos:
    name: jbig2enc 0.30 (+leptonica) — macOS
    runs-on: macos-14
    steps:
      - name: Install build deps (Homebrew)
        run: |
          brew update
          brew install autoconf automake libtool pkg-config git \
                       libpng jpeg-turbo libtiff
      - name: Build Leptonica (from source)
        run: |
          set -eux
          git clone --depth 1 https://github.com/DanBloomberg/leptonica.git
          cd leptonica
          ./autogen.sh
          ./configure --prefix="$PWD/../install_lept"
          make -j
          make install
      - name: Build jbig2enc 0.30
        run: |
          set -eux
          git clone --depth 1 --branch 0.30 https://github.com/agl/jbig2enc.git
          cd jbig2enc
          ./autogen.sh
          PKG_CONFIG_PATH="$PWD/../install_lept/lib/pkgconfig" ./configure --prefix="$PWD/../install_jb2"
          make -j
          make install
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: jbig2enc-0.30-macOS
          path: install_jb2/**

  # ===================== jbig2enc + Leptonica (Windows) ========================
  jbig2enc_windows:
    name: jbig2enc 0.30 (+leptonica) — Windows
    runs-on: windows-latest
    steps:
      - name: Setup MSYS2 (MINGW64)
        uses: msys2/setup-msys2@v2
        with:
          release: false
          update: true
          msystem: MINGW64
          install: >-
            base-devel
            git
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-libpng
            mingw-w64-x86_64-libjpeg-turbo
            mingw-w64-x86_64-libtiff
            mingw-w64-x86_64-zlib
      - name: Build Leptonica (from source)
        shell: msys2 {0}
        run: |
          set -eux
          git clone --depth 1 https://github.com/DanBloomberg/leptonica.git
          cd leptonica
          ./autogen.sh
          ./configure --prefix="$PWD/../install_lept"
          make -j
          make install
      - name: Build jbig2enc 0.30
        shell: msys2 {0}
        run: |
          set -eux
          git clone --depth 1 --branch 0.30 https://github.com/agl/jbig2enc.git
          cd jbig2enc
          ./autogen.sh
          PKG_CONFIG_PATH="$PWD/../install_lept/lib/pkgconfig" ./configure --prefix="$PWD/../install_jb2"
          make -j
          make install
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: jbig2enc-0.30-Windows
          path: install_jb2/**

  # ============================== veraPDF (Linux) ==============================
  verapdf_linux:
    name: veraPDF 1.28.2 — Linux
    runs-on: ubuntu-22.04
    steps:
      - name: Download veraPDF (zip + asc)
        run: |
          set -eux
          mkdir out && cd out
          curl -fLO https://software.verapdf.org/rel/arlington/1.28/verapdf-arlington-1.28.2-installer.zip
          curl -fLO https://software.verapdf.org/rel/arlington/1.28/verapdf-arlington-1.28.2-installer.zip.asc
      - name: Upload veraPDF bundle
        uses: actions/upload-artifact@v4
        with:
          name: verapdf-1.28.2-Linux
          path: out/**

  # ============================== veraPDF (macOS) ==============================
  verapdf_macos:
    name: veraPDF 1.28.2 — macOS
    runs-on: macos-14
    steps:
      - name: Download veraPDF (zip + asc)
        run: |
          set -eux
          mkdir out && cd out
          curl -fLO https://software.verapdf.org/rel/arlington/1.28/verapdf-arlington-1.28.2-installer.zip
          curl -fLO https://software.verapdf.org/rel/arlington/1.28/verapdf-arlington-1.28.2-installer.zip.asc
      - name: Upload veraPDF bundle
        uses: actions/upload-artifact@v4
        with:
          name: verapdf-1.28.2-macOS
          path: out/**

  # ============================== veraPDF (Windows) ============================
  verapdf_windows:
    name: veraPDF 1.28.2 — Windows
    runs-on: windows-latest
    steps:
      - name: Download veraPDF (zip + asc)
        shell: bash
        run: |
          set -eux
          mkdir out && cd out
          curl -fLO https://software.verapdf.org/rel/arlington/1.28/verapdf-arlington-1.28.2-installer.zip
          curl -fLO https://software.verapdf.org/rel/arlington/1.28/verapdf-arlington-1.28.2-installer.zip.asc
      - name: Upload veraPDF bundle
        uses: actions/upload-artifact@v4
        with:
          name: verapdf-1.28.2-Windows
          path: out/**
